name: CI
on:
push: { branches: [ main, master ] }
pull_request: {}

jobs:
lint:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- name: Lint (placeholder)
run: |
mkdir -p reports
echo "lint ok" > reports/lint.txt
- uses: actions/upload-artifact@v4
with: { name: lint, path: reports/lint.txt }

compile:
runs-on: ubuntu-latest
steps:
- uses: actions/checkout@v4
- name: Compile (forge or hardhat)
run: |
set -e
if command -v forge >/dev/null 2>&1; then
forge build
else
npm --version >/dev/null 2>&1 || sudo apt-get update && sudo apt-get install -y npm
npx --yes hardhat compile || echo "hardhat not configured; skipping"
fi

unit:
runs-on: ubuntu-latest
needs: [compile]
steps:
- uses: actions/checkout@v4
- name: Unit (placeholder -> unit.json)
run: |
mkdir -p reports
bash scripts/ci-placeholders.sh reports
- uses: actions/upload-artifact@v4
with: { name: unit, path: reports/unit.json }

invariants:
runs-on: ubuntu-latest
needs: [unit]
steps:
- uses: actions/checkout@v4
- name: Invariants (placeholder -> invariants.json)
run: |
mkdir -p reports
bash scripts/ci-placeholders.sh reports
- uses: actions/upload-artifact@v4
with: { name: invariants, path: reports/invariants.json }

static-analysis:
runs-on: ubuntu-latest
needs: [unit]
steps:
- uses: actions/checkout@v4
- name: Static Analysis (placeholder slither/mythril)
run: |
mkdir -p reports
bash scripts/ci-placeholders.sh reports
- uses: actions/upload-artifact@v4
with: { name: static, path: reports/slither.json }

gas:
runs-on: ubuntu-latest
needs: [compile]
steps:
- uses: actions/checkout@v4
- name: Gas snapshot (placeholder -> gas.json)
run: |
mkdir -p reports
bash scripts/ci-placeholders.sh reports
- uses: actions/upload-artifact@v4
with: { name: gas, path: reports/gas.json }

collate:
runs-on: ubuntu-latest
needs: [unit, invariants, static-analysis, gas]
steps:
- uses: actions/checkout@v4
- name: Prepare Node
run: |
sudo apt-get update && sudo apt-get install -y nodejs npm || true
- name: Collate artifacts and enforce gates
run: |
mkdir -p reports
# Ensure placeholder files exist (until real jobs overwrite)
bash scripts/ci-placeholders.sh reports
node scripts/ci-collate.js reports > reports/ci-summary.json
- uses: actions/upload-artifact@v4
with:
name: summary
path: reports/
