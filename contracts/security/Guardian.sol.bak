// SPDX-License-Identifier: AGPL-3.0
pragma solidity ^0.8.30;

import "../interfaces/ISafetyAutomata.sol";

/// @title Guardian (Emergency System Pause Controller)
/// @notice Manages temporary global pause/unpause rights for critical modules.
/// @dev Minimal, test-friendly version with public setter to wire SafetyAutomata.
contract Guardian {
    // --- State ---
    address public immutable dao;
    uint256 public immutable sunsetBlock; // block at which guardian expires
    ISafetyAutomata public safetyAutomata; // wired in tests via setSafetyAutomata()

    // --- Events ---
    event SystemPaused(address indexed by, bytes32 module, uint256 atBlock);
    event SystemResumed(address indexed by, bytes32 module, uint256 atBlock);
    event SafetyWired(address indexed by, address safety);

    // --- Modifiers ---
    modifier onlyDAO() {
        require(msg.sender == dao, "not DAO");
        _;
    }

    modifier onlyActiveGuardian() {
        require(block.number < sunsetBlock, "guardian expired");
        _;
    }

    // --- Ctor (2 params: matches your current test) ---
    constructor(address _dao, uint256 _sunsetBlocks) {
        require(_dao != address(0), "ZERO_ADDRESS");
        dao = _dao;
        sunsetBlock = block.number + _sunsetBlocks;
    }

    // --- Wire SafetyAutomata explicitly from tests or deployment scripts ---
    // --- Wire SafetyAutomata explicitly from tests or deployment scripts ---
    function setSafetyAutomata(ISafetyAutomata _safety) external {
        require(address(_safety) != address(0), "ZERO_ADDRESS");
        safetyAutomata = _safety;
        emit SafetyWired(msg.sender, address(_safety));
    }

    /// @notice Auto-register this Guardian in SafetyAutomata (for testing and setup)
    function selfRegister() external onlyActiveGuardian {
        require(address(safetyAutomata) != address(0), "SafetyAutomata not set");
        safetyAutomata.grantGuardian(address(this));
    }

