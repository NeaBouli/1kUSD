# v0.50.0 â€“ Economic Layer

**Scope:** DEV-43 bis DEV-52  
**Status:** 40/40 Tests green, based on \`main\` after tag \`v0.49.0\`.

---

## ðŸ”¹ High-Level Summary (EN)

This release completes the **first full economic layer** on top of the 1kUSD PSM stack:

- Fully bidirectional PSM (mint + redeem) with real asset flows
- Registry-driven **decimals, fees and spreads**
- Hard **notional limits** via PSMLimits
- **Oracle health gates** (stale + price-jump) feeding into Guardian / Safety

The system is now ready for risk parameterization and testnet-level governance experiments.

---

## ðŸ§± Core Changes

### 1) PSM: Real Flows + Roundtrip Regression

**PegStabilityModule**

- \`swapTo1kUSD\`:
  - Pulls collateral from user â†’ \`CollateralVault\`
  - Mints 1kUSD to recipient
  - Routes fees via \`FeeRouter\` on 1kUSD notional
- \`swapFrom1kUSD\`:
  - Burns 1kUSD from user
  - Withdraws collateral from vault
  - Sends collateral to recipient

**Tests**

- \`PSMRegression_Flows\`:
  - \`testMintFlow_1to1()\`
  - \`testRoundTrip_MintThenRedeem()\` (full mint+redeem roundtrip with vault accounting)

---

### 2) ParameterRegistry Integration (Decimals, Fees, Spreads)

#### Decimals

- Keys:
  - Global: \`psm:tokenDecimals\`
  - Per-token: \`keccak256(abi.encode(KEY_TOKEN_DECIMALS, token))\`
- Behaviour:
  - If no registry or no entry â†’ safe fallback to **18 decimals**
  - Used in both mint & redeem paths

#### Fees (bps)

- Global keys:
  - \`psm:mintFeeBps\`
  - \`psm:redeemFeeBps\`
- Per-token overrides:
  - \`keccak256(abi.encode(KEY_MINT_FEE_BPS, token))\`
  - \`keccak256(abi.encode(KEY_REDEEM_FEE_BPS, token))\`
- Resolution order:
  1. Per-token entry (if \> 0)
  2. Global entry (if \> 0)
  3. Local PSM storage (\`mintFeeBps\` / \`redeemFeeBps\`)
- Invariant:
  - \`feeBps <= 10_000\`

#### Spreads (bps)

- Global keys:
  - \`psm:mintSpreadBps\`
  - \`psm:redeemSpreadBps\`
- Per-token overrides:
  - Analog zu Fees mit \`KEY_MINT_SPREAD_BPS\`, \`KEY_REDEEM_SPREAD_BPS\`
- Applied as:
  - \`totalBps = feeBps + spreadBps\`
  - \`require(totalBps <= 10_000, "PSM: fee+spread too high");\`
  - Both mint & redeem paths use \`totalBps\`.

**Tests**

- \`PSMRegression_Fees\`:
  - \`testMintUsesGlobalRegistryFee()\`
  - \`testMintPerTokenOverrideBeatsGlobal()\`
  - \`testRedeemUsesGlobalRegistryFee()\`

---

### 3) PSMLimits: Notional Caps

- Limits enforced on **1kUSD notional**:
  - \`singleTxCap\`
  - \`dailyCap\`
- \`limits.checkAndUpdate(notional1k)\` is called from PSM for both directions.
- Configured directly on the \`PSMLimits\` contract (not via registry).

**Tests**

- \`PSMLimits.t.sol\` + \`PSMRegression_Limits\`:
  - \`testDailyCapReverts()\`
  - \`testDailyReset()\`
  - \`testSingleTxLimitReverts()\`

---

### 4) OracleAggregator: Health Gates (Stale + Diff)

New registry-driven parameters:

- \`oracle:maxStale\` (seconds)
- \`oracle:maxDiffBps\` (basis points)

**OracleAggregator**

- Checks **staleness** (timestamp vs \`maxStale\`)
- Checks **relative price jump** vs previous price (\`maxDiffBps\`)
- Marks price unhealthy if thresholds are breached.
- Integrated with \`SafetyAutomata\` via \`MODULE_ID = keccak256("ORACLE")\`.

**Tests**

- \`OracleRegression_Health\`:
  - \`testMaxDiffBpsAllowsSmallJump()\`
  - \`testMaxDiffBpsMarksLargeJumpUnhealthy()\`
  - \`testMaxStaleMarksOldPriceUnhealthy()\`
  - \`testMaxStaleZeroDoesNotAlterHealth()\`
- \`OracleRegression_Watcher\` + \`Guardian_OraclePropagation\` remain green.

---

### 5) Guardian / Safety Integration

- \`Guardian_PSMUnpause\`:
  - Ensures that PSM operations resume successfully after Safety unpause.
  - Adjusted to be compatible with registry-fallback behaviour (decimals).
- All Guardian / Safety suites remain green:
  - PSM pause / unpause
  - Oracle pause propagation
  - Generic health probes

---

## ðŸ“š Docs & Logging

- \`docs/architecture/psm_dev43-45.md\`
  - Extended with ParameterRegistry-based **decimals + fees** and Oracle health gates.
- \`docs/architecture/psm_parameters.md\`
  - Parameter map for:
    - PSM Decimals, Fees, Spreads
    - Oracle \`maxStale\` / \`maxDiffBps\`
    - PSMLimits caps
    - Governance roles & responsibilities (DAO / Risk / Guardian).
- \`README.md\`
  - Summary for:
    - PSM notional layer, registry integration, limits
    - Oracle health model
- \`logs/project.log\`
  - Entries for DEV-48 (fees), DEV-49 (oracle health), DEV-52 (spreads).

---

## ðŸ§ª Test Status

- **Total:** 40 tests  
- **Suites (excerpt):**
  - \`PSMRegression_Flows\`
  - \`PSMRegression_Limits\`
  - \`PSMRegression_Fees\`
  - \`OracleRegression_Watcher\`
  - \`OracleRegression_Health\`
  - Guardian / DAO Timelock / Vault / Router placeholder suites  
- All green on \`main\` (post-DEV-52).

---

## ðŸ‡©ðŸ‡ª Kurzfassung (fÃ¼r internes Protokoll)

- PSM kann jetzt **real minten & redeemen**, inklusive Vault-Flows und Fee-Routing.
- Decimals, Fees und Spreads kommen **aus der ParameterRegistry** (mit sicheren Fallbacks).
- Notional-Limits (daily/single) sind aktiv und getestet.
- Der Oracle-Stack besitzt **Health-Gates fÃ¼r alte Preise und zu groÃŸe Preis-SprÃ¼nge**, die in Guardian/Safety einflieÃŸen.
- Docs und Logs sind aktualisiert, sodass DEV-43â€“52 als **sauberes Ã¶konomisches Paket** nachvollziehbar sind.
